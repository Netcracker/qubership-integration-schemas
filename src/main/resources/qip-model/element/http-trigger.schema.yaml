---
$id: http://qubership.org/schemas/product/qip/element/http-trigger.schema.yaml
$schema: http://json-schema.org/draft-07/schema
type: object
allOf:
  - $ref: "http://qubership.org/schemas/product/qip/element/properties/common-element-properties.schema.yaml"
title: Http Trigger
description: >
  HTTP Trigger provides an HTTP endpoint for consuming arriving HTTP requests.
properties:
  type:
    type: string
    const: http-trigger
  properties:
    type: object
    allOf:
      - $ref: "http://qubership.org/schemas/product/qip/element/properties/correlation-id.schema.yaml"
      - $ref: "http://qubership.org/schemas/product/qip/element/properties/idempotency.schema.yaml"
      - $ref: "#/definitions/AccessControlProperties"
      - oneOf:
        - $ref: "#/definitions/CustomEndpoint"
        - $ref: "#/definitions/ImplementedServiceEndpoint"
      - $ref: "#/definitions/ValidationFailureHandler"
      - $ref: "#/definitions/ChainFailureHandler"
    properties:
      chunked:
        type: boolean
        default: true
        title: Chunked
        description: >
          If this option is false the Servlet will disable the HTTP streaming
          and set the content-length header on the response.
      externalRoute:
        type: boolean
        default: true
        title: External route
        description: >
          If checked, HTTP trigger will be registered as "external" on public
          gateway.
          Checkbox is inactive when default route registration is disabled in
          global environment settings.
      privateRoute:
        type: boolean
        default: false
        title: Private route
        description: >
          If checked, HTTP trigger will be registered as "Private" on private
          gateway.
          Checkbox is inactive when default route registration is disabled in
          global environment settings.
      responseFilter:
        type: boolean
        title: Response filter
        description: >
          Turns on ability to handle additional query parameters "fields" and
          "excludeFields" to include only specific fields in response
          or exclude them from there. This is only supported for responses
          in JSON.
      connectTimeout:
        oneOf:
          - $ref: "http://qubership.org/schemas/product/qip/base.schema.yaml#/definitions/IntegerOrVariablePlaceholder"
          - $ref: "http://qubership.org/schemas/product/qip/base.schema.yaml#/definitions/SimpleExpression"
        title: Connection timeout (ms)
        description: >
          Specifies connection timeout in millis (default value will be used
          if nothing is given).
        default: 120000
      killSessionOnTimeout:
        type: boolean
        default: false
        title: Terminate session on connection timeout
        description: >
          If checked, connection timeout will trigger session termination
          process. Chain session might not be finished.
      rejectRequestIfNonNullBodyGetDelete:
        type: boolean
        default: true
        title: Reject request if body is not empty for GET, DELETE methods
        description: >
          Incoming request will be rejected with an error,
          if body is received for GET and DELETE methods.
      allowedContentTypes:
        type: array
        items:
          type: string
        title: Allowed Content Types
        description: If no content types defined - validation disabled.
      validationSchema:
        type: string
        title: Json Request Schema
        description: Schema for input message validation.
      httpBinding:
        type: string
        default: handlingHttpBinding
definitions:
  AccessControlProperties:
    type: object
    properties:
      accessControlType:
        title: Access Control Type
        default: RBAC
        type: string
        enum:
          - RBAC
          - ABAC
    required:
      - accessControlType
    if:
      properties:
        accessControlType:
          const: RBAC
    then: # rbac
      properties:
        roles:
          title: Roles
          type: array
          items:
            type: string
    else: # abac
      properties:
        abacResource:
          type: string
          title: Resource
          description: ABAC resource, usually the same as the trigger URI.
      required:
        - abacResource
  CustomEndpoint:
    title: Custom Endpoint
    type: object
    properties:
      contextPath:
        type: string
        title: Path
      httpMethodRestrict:
        type: string
        title: HTTP Methods
        pattern: "^(POST|GET|PUT|DELETE|PATCH|HEAD|OPTIONS)(,(POST|GET|PUT|DELETE|PATCH|HEAD|OPTIONS))*$"
    required:
      - contextPath
  ImplementedServiceEndpoint:
    title: Implemented Service Endpoint
    type: object
    properties:
      integrationOperationId:
        type: string
        title: Operation ID
      integrationSpecificationGroupId:
        type: string
        title: Specification group ID
      integrationSpecificationId:
        type: string
        title: Specification ID
      integrationSystemId:
        type: string
        title: Service ID
      systemType:
        title: Service type
        $ref: "http://qubership.org/schemas/product/qip/service.schema.yaml#/definitions/ServiceType"
      integrationOperationMethod:
        type: string
        title: Operation method
      integrationOperationPath:
        type: string
        title: Operation name
    required:
      - integrationOperationPath
  ValidationFailureHandler:
    type: object
    required:
      - handleValidationAction
    properties:
      handleValidationAction:
        type: string
        enum:
          - default
          - script
          - mapper-2
        default: default
        title: Action on validation failure
      handlerContainer:
        type: object
    allOf:
      - if:
          properties:
            handleValidationAction:
              const: script
        then:
          required:
            - handlerContainer
          properties:
            handlerContainer:
              $ref: "http://qubership.org/schemas/product/qip/element/script.schema.yaml#/definitions/ScriptProperties"
      - if:
          properties:
            handleValidationAction:
              const: mapper-2
        then:
          required:
            - handlerContainer
          properties:
            handlerContainer:
              $ref: "http://qubership.org/schemas/product/qip/element/mapper-2.schema.yaml#/definitions/MapperParameters"
      - if:
          properties:
            handleValidationAction:
              const: default
        then:
          properties:
            handlerContainer:
              type: object
  ChainFailureHandler:
    type: object
    required:
      - handleChainFailureAction
    properties:
      handleChainFailureAction:
        type: string
        enum:
          - default
          - script
          - mapper-2
          - chain-call
        default: default
        title: Action on response failure
      chainFailureHandlerContainer:
        type: object
    allOf:
      - if:
          properties:
            handleChainFailureAction:
              const: script
        then:
          required:
            - chainFailureHandlerContainer
          properties:
            chainFailureHandlerContainer:
              $ref: "http://qubership.org/schemas/product/qip/element/script.schema.yaml#/definitions/ScriptProperties"
      - if:
          properties:
            handleChainFailureAction:
              const: mapper-2
        then:
          required:
            - chainFailureHandlerContainer
          properties:
            chainFailureHandlerContainer:
              $ref: "http://qubership.org/schemas/product/qip/element/mapper-2.schema.yaml#/definitions/MapperParameters"
      - if:
          properties:
            handleChainFailureAction:
              const: chain-call
        then:
          required:
            - chainFailureHandlerContainer
          properties:
            chainFailureHandlerContainer:
              type: object
              properties:
                elementId:
                  type: string
              required:
                - elementId
              additionalProperties: false
      - if:
          properties:
            handleChainFailureAction:
              const: default
        then:
          properties:
            chainFailureHandlerContainer:
              type: object
required:
  - type
