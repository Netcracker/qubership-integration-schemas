---

# This GitHub Actions workflow can be triggered in two ways:
# 1. Automatically on push to any branch (runs in dry-run mode for safety)
# 2. Manually via workflow_dispatch with configurable parameters
#
# The workflow delegates the actual NPM publishing process to the re-npm-publish.yml workflow
# from the qubership-workflow-hub repository, which performs the following tasks:
# 1. Checks out the repository.
# 2. Sets up Node.js environment.
# 3. Installs dependencies.
# 4. Detects if the project is a Lerna monorepo.
# 5. Updates dependencies if required.
# 6. Updates package version in package.json or lerna.json.
# 7. Builds the project.
# 8. Runs tests.
# 9. Commits and pushes changes.
# 10. Publishes the package to NPM registry.

# To make it work for your project, you need to adjust the package.json and add configuration file for GitHub release.
# Please find detailed instructions:
# https://github.com/netcracker/qubership-workflow-hub?tab=readme-ov-file#npm-project-release-workflow
#
# Note: When triggered by push, the workflow automatically runs in dry-run mode to prevent
# accidental publishing. Use workflow_dispatch for actual releases.

name: Publish NPM package

run-name: NPM Package${{ (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.dry-run)) && ' - Test' || ' - Publish' }}${{ (github.event_name == 'workflow_dispatch' && !inputs.dry-run && inputs.version) && format(' {0}', inputs.version) || '' }}

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version for NPM (e.g., 1.0.0)'
        required: true
        type: string
      scope:
        description: 'NPM scope for the package'
        required: false
        type: string
        default: '@netcracker'
      node-version:
        description: 'Node js vesion'
        required: false
        type: string
        default: "22.x"
      registry-url:
        description: 'Registry version'
        required: false
        type: string
        default: "https://npm.pkg.github.com"
      update-nc-dependency:
        description: 'Update nc dependency'
        required: false
        type: boolean
        default: false
      dry-run:
        description: 'Run in dry-run mode (no actual publishing)'
        required: false
        type: boolean
        default: false
      npm-dist-tag:
        description: 'NPM distribution tag'
        required: false
        type: string
        default: 'latest'
      update-ui:
        description: 'Update schemas version in UI'
        required: false
        type: boolean
        default: true
  workflow_call:
    inputs:
      version:
        description: 'Release version for NPM (e.g., 1.0.0)'
        required: false
        type: string
      scope:
        description: 'NPM scope for the package'
        required: true
        type: string
        default: '@netcracker'
      node-version:
        description: 'Node js vesion'
        required: false
        type: string
        default: "22.x"
      registry-url:
        description: 'Registry version'
        required: false
        type: string
        default: "https://npm.pkg.github.com"
      update-nc-dependency:
        description: 'Update nc dependency'
        required: false
        type: boolean
        default: false
      dry-run:
        description: 'Run in dry-run mode (no actual publishing)'
        required: false
        type: boolean
        default: false
      npm-dist-tag:
        description: 'NPM distribution tag'
        required: false
        type: string
        default: 'latest'
      update-ui:
        description: 'Update schemas version in UI'
        required: false
        type: boolean
        default: true
    secrets:
      GH_ACCESS_TOKEN:
        required: true

permissions:
  contents: read

jobs:
  npm-publish:
    uses: Netcracker/qubership-workflow-hub/.github/workflows/re-npm-publish.yml@8af13ac7ea017b87a8501e9b119a5c86c532a5b2
    permissions:
      contents: write
      packages: write
    with:
      version: ${{ inputs.version || '' }}
      scope: ${{ inputs.scope || '@netcracker' }}
      node-version: ${{ inputs.node-version || '22.x' }}
      registry-url: ${{ inputs.registry-url || 'https://npm.pkg.github.com' }}
      update-nc-dependency: ${{ inputs.update-nc-dependency || false }}
      dry-run: ${{ inputs.dry-run }}
      dist-tag: ${{ inputs.npm-dist-tag || 'latest' }}
      ref: ${{ github.ref_name }}
    secrets: inherit

  update-version-in-ui:
    if: inputs.update-ui == true
    needs: npm-publish
    runs-on: ubuntu-latest
    steps:
      - name: Trigger UI action
        uses: netcracker/qubership-workflow-hub/actions/custom-event@c1a5c8c2d9c2a79f548134db1d095f36ee0f28e7 # v2.0.7
        with:
          event-type: "schemas-dependency-update"
          client-payload: '{"version": "${{ inputs.version }}"}'
          github-token: ${{ secrets.GH_ACCESS_TOKEN }}
          repo: "qubership-integration-ui"
          owner: "Netcracker"
